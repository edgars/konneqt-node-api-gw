<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konneqt Micro API Gateway</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
   <!-- Prism.js CSS for Syntax Highlighting -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">

  <style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=MuseoModerno:ital,wght@0,100..900;1,100..900&display=swap');    
     body {
        font-family: "JetBrains Mono", serif;
      }
      th,td{
        font-size: small;
      }
      button{
        font-size: xx-small;
      }
      .line-numbers .line-numbers-rows {
      border-right: 1px solid #444444; /* Line numbers border */
    }

    </style>
</head>

<body>
  <div class="container mt-5">
    <h1 class="text-left mb-4">Konneqt Micro API Gateway</h1>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="crudTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#formTabContent" type="button" role="tab" aria-controls="formTabContent" aria-selected="true">
          API Routes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#jsonTabContent" type="button" role="tab" aria-controls="jsonTabContent" aria-selected="false">
          JSON Source
        </button>
      </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="crudTabsContent">
      <!-- Tab 1: Form and Table -->
      <div class="tab-pane fade show active" id="formTabContent" role="tabpanel" aria-labelledby="form-tab">
        <div class="d-flex justify-content-end my-3">
          <button id="addRouteBtn" class="btn btn-primary">Add New Route</button>
        </div>
        <div class="table-responsive">
          <table id="routesTable" class="table table-bordered table-dark table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>Method</th>
                <th>URL</th>
                <th>Proxy Target</th>
                <th>Pre Interceptors</th>
                <th>Post Interceptors</th>
                <th>Rate Limit</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab 2: JSON View -->
      <div class="tab-pane fade" id="jsonTabContent" role="tabpanel" aria-labelledby="json-tab">
        <div class="mt-3">
          <h5>Updated JSON:</h5>
          <pre class="line-numbers bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;">
            <code id="jsonView" class="language-json">
              <!-- Syntax-highlighted JSON content with line numbers will go here -->
            </code>
          </pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Add/Edit -->
  <div class="modal fade" id="routeModal" tabindex="-1" aria-labelledby="routeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="routeForm">
          <div class="modal-header">
            <h5 class="modal-title" id="routeModalLabel">Add Route</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="routeIndex">

            <div class="mb-3">
              <label for="method" class="form-label">Method</label>
              <input type="text" id="method" class="form-control" required>
            </div>

            <div class="mb-3">
              <label for="url" class="form-label">URL</label>
              <input type="text" id="url" class="form-control" required>
            </div>

            <div class="mb-3">
              <label for="proxyTarget" class="form-label">Proxy Target</label>
              <input type="text" id="proxyTarget" class="form-control" required>
            </div>

            <div class="mb-3">
              <label for="preInterceptors" class="form-label">Pre Interceptors</label>
              <input type="text" id="preInterceptors" class="form-control" placeholder="Comma-separated values">
            </div>

            <div class="mb-3">
              <label for="postInterceptors" class="form-label">Post Interceptors</label>
              <input type="text" id="postInterceptors" class="form-control" placeholder="Comma-separated values">
            </div>

            <div class="mb-3">
              <label for="rateLimit" class="form-label">Rate Limit (max:timeWindow)</label>
              <input type="text" id="rateLimit" class="form-control" placeholder="e.g., 50:1 minute">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Prism.js JS for Syntax Highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  
  <!-- Prism.js Line Numbers Plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

  <script>
$(document).ready(function () {
  let routes = [
    {
      method: "GET",
      url: "/api/users",
      proxy: { target: "https://jsonplaceholder.typicode.com/users" },
      preInterceptors: ["interceptors/logRequest.js"],
      postInterceptors: ["interceptors/logResponse.js"],
      rateLimit: { max: 50, timeWindow: "1 minute" },
    },
    {
      method: "GET",
      url: "/api/posts",
      proxy: { target: "https://jsonplaceholder.typicode.com/posts" },
      preInterceptors: ["interceptors/authInterceptor.js"],
      postInterceptors: [],
    },
  ];

  const renderTable = () => {
    const tbody = $("#routesTable tbody");
    tbody.empty(); // Clear existing table rows

    routes.forEach((route, index) => {
      tbody.append(`
        <tr>
          <td>${index + 1}</td>
          <td>${route.method}</td>
          <td>${route.url}</td>
          <td>${route.proxy.target}</td>
          <td>${route.preInterceptors.join(", ")}</td>
          <td>${route.postInterceptors.join(", ")}</td>
          <td>${route.rateLimit ? `${route.rateLimit.max}:${route.rateLimit.timeWindow}` : "None"}</td>
          <td>
            <button class="btn btn-warning btn-sm editRouteBtn" data-index="${index}">Edit</button>
            <button class="btn btn-danger btn-sm deleteRouteBtn" data-index="${index}">Delete</button>
          </td>
        </tr>
      `);
    });

    // Update the JSON view with syntax highlighting
    const jsonView = $("#jsonView");
    jsonView.text(JSON.stringify(routes, null, 2)); // Update JSON text
    Prism.highlightElement(jsonView[0]); // Highlight syntax
  };

  const resetForm = () => {
    $("#routeForm")[0].reset(); // Clear the form
    $("#routeIndex").val(""); // Clear the hidden index field
  };

  // Add Route Button (Opens Modal)
  $("#addRouteBtn").on("click", () => {
    resetForm();
    $("#routeModalLabel").text("Add Route");
    $("#routeModal").modal("show");
  });

  // Save Button in the Modal
  $("#routeForm").on("submit", (e) => {
    e.preventDefault(); // Prevent form submission

    const index = $("#routeIndex").val(); // Get the index (if editing)
    const newRoute = {
      method: $("#method").val(),
      url: $("#url").val(),
      proxy: { target: $("#proxyTarget").val() },
      preInterceptors: $("#preInterceptors")
        .val()
        .split(",")
        .map((i) => i.trim())
        .filter((i) => i),
      postInterceptors: $("#postInterceptors")
        .val()
        .split(",")
        .map((i) => i.trim())
        .filter((i) => i),
      rateLimit: (() => {
        const [max, timeWindow] = $("#rateLimit").val().split(":");
        return max && timeWindow ? { max: parseInt(max), timeWindow } : null;
      })(),
    };

    if (index) {
      // If index exists, update the route
      routes[index] = newRoute;
    } else {
      // If index does not exist, add a new route
      routes.push(newRoute);
    }

    $("#routeModal").modal("hide"); // Close the modal
    renderTable(); // Re-render the table
  });

  // Edit Button (Event Delegation)
  $(document).on("click", ".editRouteBtn", function () {
    const index = $(this).data("index"); // Get the index of the route
    const route = routes[index];

    // Fill the modal form with the route data
    $("#routeIndex").val(index); // Store the index in a hidden field
    $("#method").val(route.method);
    $("#url").val(route.url);
    $("#proxyTarget").val(route.proxy.target);
    $("#preInterceptors").val(route.preInterceptors.join(", "));
    $("#postInterceptors").val(route.postInterceptors.join(", "));
    $("#rateLimit").val(
      route.rateLimit
        ? `${route.rateLimit.max}:${route.rateLimit.timeWindow}`
        : ""
    );

    $("#routeModalLabel").text("Edit Route"); // Update modal title
    $("#routeModal").modal("show"); // Show the modal
  });

  // Delete Button (Event Delegation)
  $(document).on("click", ".deleteRouteBtn", function () {
    const index = $(this).data("index"); // Get the index of the route

    if (confirm("Are you sure you want to delete this route?")) {
      routes.splice(index, 1); // Remove the route from the array
      renderTable(); // Re-render the table
    }
  });

  // Initial Render
  renderTable();
});
  </script>
</body>
</html>
